(function(){var e,t,n,r,i,s,o,u,a,f,l;e={container:null,spine:null,start_date:null,end_date:null,intervals:[],no_of_intervals:0,structure:{},moments:[],pct_buffer_for_markers:3,spine_buffer:5,initial_heights:{up:[-10,-22,-28],down:[8,10,14]},date_to_marker_index:function(e){return Math.floor((e-this.start_date)/(1e3*60*60*24))},pct_per_interval:function(){return(100-this.pct_buffer_for_markers)/(this.intervals.length-1)},date_to_marker_left_pct:function(e){return this.pct_buffer_for_markers+this.pct_per_interval()*this.date_to_marker_index(f(e))}};window.create_timeline=function(t){if(typeof $==="undefined"||$===null){$("head").append($('<script/ src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">'))}if(!(t.destination!=null&&(e.start_date=f(t.start_date))!=null&&(e.end_date=f(t.end_date))!=null)){console.log("You are missing either destination or timeline start/end dates.")}else{n(e.spine=i(t.destination))}if(t.moments.length!==0){e.structure=t.structure;t.moments.map(function(e){var t;return t=[f(e.start),f(e.end)],e.start=t[0],e.end=t[1],t});e.moments=t.moments.sort(function(e,t){return e.start-t.start});return r(e.spine)}};i=function(t){var n,r;n=function(){var t;t=u(15,"black").css("left",0).hide();t.hover(function(){return t.css("background-color","blue")},function(){return t.css("background-color","black")}).data("clicked",true).click(function(){var n,r,i,s,u;n=t.data("clicked");u=e.moments;for(i=0,s=u.length;i<s;i++){r=u[i];r.is_expanded=n}t.data("clicked",!n);return o()});return t};r=e.spine_buffer;e.container=$('<div/ class="timeline_container">').appendTo(t);return $('<div/ class="spine">').appendTo(e.container).css({left:r+"%",width:0}).animate({width:97-r+"%"},{duration:400}).append(n().addClass("origin").delay(400).fadeIn(300))};n=function(t){var n,r,i,s,o,u,l,c,h,p,d;l=function(e){if(e.date===1){return e.priority=3}else if(e.day===1){return e.priority=2}else{return e.priority=1}};u=function(){var t,n,r,i,s,o,u;o=[e.start_date,e.end_date].map(f),r=o[0],t=o[1];while(r<=t){e.intervals.push({date:r.getDate(),day:r.getDay(),month:r.getMonth(),year:r.getFullYear(),js_date:new Date(r.getTime())});r.setDate(r.getDate()+1)}u=e.intervals;for(i=0,s=u.length;i<s;i++){n=u[i];l(n)}return e.intervals};n=function(t){return $('<div/ class="interval_label p'+t.priority+'">').css({left:e.date_to_marker_left_pct(t.js_date)+"%"})};p=s=u();d=[];for(c=0,h=p.length;c<h;c++){i=p[c];o=e.date_to_marker_left_pct(i.js_date)+"%";$('<div/ class="interval_marker p'+i.priority+'">').css("left",o).delay(800).fadeIn().appendTo(t);r=n(i);switch(i.priority){case 3:r.text(a(i.month));break;case 2:r.text("Mon "+i.date)}if(r.priority!==1){d.push(r.appendTo(t))}else{d.push(void 0)}}return d};r=function(t){var n,r,i,s,a,f,c,h,p,d,v;r=function(n){var r,i,s,o;o=[e.date_to_marker_left_pct(n.start)+"%",e.date_to_marker_left_pct(n.end)+"%"],s=o[0],i=o[1];r=["#47ACCA","#E0524E"];n.start_marker=u(7,r[0]).addClass("start").css("left",s);n.end_marker=u(7,r[1]).addClass("end").css("left",i).hide();return t.append(n.start_marker,n.end_marker)};n=function(t){var n,r,i,s,u;s=function(t,n){var r,i,s,o,u;i="";u=e.structure.title;for(s=0,o=u.length;s<o;s++){r=u[s];i+=t[r]+":"}t.collapsed={};t.collapsed.elem=$('<div/ class="info_elem collapsed">').text(i.slice(0,-1));return n(t)};u=function(t){var n,r,i,s,o,u,a,f,l,c,h;n=$('<div/ class="info_elem expanded">');u=t.collapsed.elem.text()+" - ";h=e.structure.extendedTitle;for(a=0,l=h.length;a<l;a++){i=h[a];u+=t[i]+", "}t.collapsed.elem.clone().addClass("expanded").text(u.slice(0,-2)).appendTo(n);u="";o=e.structure.content.names;s=e.structure.content.keys;for(r=f=0,c=s.length;f<c;r=++f){i=s[r];if(t[i]!=null){$('<a/ class="content_link">').text(o[r]).click(function(){return window.location.href=t[links[r]]}).appendTo(n);n.html(n.html()+" / ")}}if(n.html().slice(-3)===" / "){n.html(n.html().slice(0,-3))}t.expanded={};return t.expanded.elem=n};i=function(e,t){var n,r,i;t.append(e);i=[t.width(),t.height()],r=i[0],n=i[1];e.hide();return{w:r,h:n}};r=function(t){var n,r,s,u,a,f,l;t.info_box=$('<div/ class="info_box">').appendTo(e.spine);f=[t.expanded.elem,t.collapsed.elem,t.info_box],r=f[0],n=f[1],a=f[2];l=[i(n,a),i(r,a)],t.collapsed.css=l[0],t.expanded.css=l[1];n.show();u=function(){t.end_marker.fadeIn(200);return t.duration_wire.animate({width:t.duration_wire.data("w")},{duration:200})};s=function(){t.end_marker.fadeOut(200);return t.duration_wire.animate({width:0},{duration:200})};return a.css({width:a.width(),height:a.height(),marginLeft:-a.width()/2,left:e.date_to_marker_left_pct(t.start)+"%"}).click(function(){t.is_expanded=!t.is_expanded;return o()}).hover(u,s)};n=function(t){t.bottom=function(){return this.goal_top+this.get_projected_css().ih_px};t.get_projected_css=function(){var n,r,i,s,o,u,a,f,l,c,h,p;r=n=t.collapsed;if(t.is_expanded){r=t.expanded}p=[r.css.w,r.css.h,-n.css.w/2],o=p[0],i=p[1],s=p[2];c=parseFloat(e.spine.width());f=100*s/c;a=f+(u=e.date_to_marker_left_pct(t.start));l=a+(h=100*o/c);return{l:u,iml:s,ih_px:i,ilm:a,irm:l,iw_pct:h,iw_px:o}};t.remove_end_wires=function(){var e;[t.vertical_end_wire.remove(),t.horizontal_end_wire.remove()];return e=[null,null],t.vertical_end_wire=e[0],t.horizontal_end_wire=e[1],e};t.set_initial_top=function(){var n,r,i,s,o,u,a;n=t.get_projected_css();s=Math.floor((n.ilm-e.pct_buffer_for_markers)/e.pct_per_interval()-1);u=Math.floor((n.irm-e.pct_buffer_for_markers)/e.pct_per_interval()+2);o=Math.max.apply(Math,function(){var t,n,r,o;r=e.intervals.slice(s,+u+1||9e9);o=[];for(t=0,n=r.length;t<n;t++){i=r[t];o.push(i.priority)}return o}());a=(r=e.initial_heights).down[o-1];if(this.is_up){a=r.up[o-1]-n.ih_px}return t.goal_top=a};return t.clash_with=function(e){var t,n,r,i,s,o,u,a,f;o=function(e,t){return!(e.t>t.b||t.t>e.b)};n=function(e,t){return!(e.irm<t.ilm||t.irm<e.ilm)};u=[this.get_projected_css(),e.get_projected_css()],i=u[0],r=u[1];a=[this.goal_top,this.bottom(),e.goal_top,e.bottom()],i.t=a[0],i.b=a[1],r.t=a[2],r.b=a[3];f=[o(i,r),n(i,r)],s=f[0],t=f[1];return s&&t}};s(t,u);r(t);return n(t)};h=function(e){var t,n;t=Math.abs((e.goal_top+e.bottom())/2);n=e.is_up?-t:0;return e.start_wire=l(e,e.start).addClass("vertical start").delay(800).animate({height:t,top:n},{duration:200})};c=function(t){var n;n=e.date_to_marker_left_pct(t.end)-e.date_to_marker_left_pct(t.start)+"%";return t.duration_wire=l(t,t.start).addClass("horizontal duration").data("w",n)};v=e.moments;for(i=p=0,d=v.length;p<d;i=++p){f=v[i];r(f);f.is_up=i%2===0;n(f);[f.set_initial_top(),f.info_box.css("top",f.goal_top)];h(f);c(f)}a=(s=$(".info_box")).length-1;return s.hide().delay(400).fadeIn(200,function(){if(s.index($(this))===a){return o()}})};o=function(){var n,r,i,s,o,u,a,f,l,c;o=function(e,t,n){var r,i,s;r=function(e,t,n){if(e.is_up){return e.goal_top=n.goal_top-t.ih_px-10}else{return e.goal_top=n.bottom()+10}};i=function(){var n,r,i;i=[];for(n=0,r=t.length;n<r;n++){s=t[n];if(s.clash_with(e)){i.push(s)}}return i}();if(i.length!==0){r(e,n,i[0]);return o(e,t)}else{return e.fixed=true}};u=function(e){var t,n,r,i,s,u;u=[];for(i=0,s=e.length;i<s;i++){r=e[i];t=function(){var t,i,s;s=[];for(t=0,i=e.length;t<i;t++){n=e[t];if(n.fixed&&r.id!==n.id){s.push(n)}}return s}();u.push(o(r,t,r.get_projected_css()))}return u};s=e.moments.slice(0);c=[[],[]],a=c[0],r=c[1];for(f=0,l=s.length;f<l;f++){i=s[f];[i.set_initial_top(),i.fixed=false];(i.is_up?a:r).push(i)}n=function(e,t){if(e.is_expanded===t.is_expanded){return e.start-t.start}else if(e.is_expanded){return 1}else{return-1}};[a.sort(n),r.sort(n)].map(u);return t()};s=function(t,n){var r,i,s;if(t.is_expanded&&t.horizontal_end_wire==null){i=t.is_up?n:2;s=e.date_to_marker_left_pct(t.end)-e.date_to_marker_left_pct(t.start)+"%";t.vertical_end_wire=l(t,t.end).addClass("vertical end").css("top",n);r=function(){return t.vertical_end_wire.animate({height:Math.abs(n),top:i},{duration:200})};return t.horizontal_end_wire=l(t,t.start).delay(200).addClass("horizontal end").css("top",n).animate({width:s},{duration:200,complete:function(){return r()}})}};t=function(){var t,n,r,i,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;c=e.moments;for(v=0,m=c.length;v<m;v++){l=c[v];g=[l.expanded.elem,l.collapsed.elem,l.info_box,null],o=g[0],r=g[1],f=g[2],i=g[3];if(!((y=l.is_expanded)!=null?y:l.is_expanded=false)){[o.hide(),r.show(),i=l.collapsed.css]}else{[r.hide(),o.show(),i=l.expanded.css]}f.animate({top:l.goal_top,width:i.w,height:i.h},{duration:200});u=(l.goal_top+l.bottom())/2;b=l.is_up?[u,Math.abs(u)]:[2,Math.abs(u)],d=b[0],p=b[1];l.start_wire.animate({height:p,top:d},{duration:200});if(l.horizontal_end_wire!=null&&l.is_expanded){l.horizontal_end_wire.animate({top:u},{duration:200});l.vertical_end_wire.animate({top:d,height:p},{duration:200})}else if(l.is_expanded){s(l,u)}else if(l.horizontal_end_wire!=null){l.remove_end_wires()}}w=[Math.min.apply(Math,function(){var e,t,n;n=[];for(e=0,t=c.length;e<t;e++){l=c[e];n.push(l.goal_top)}return n}()),Math.max.apply(Math,function(){var e,t,n;n=[];for(e=0,t=c.length;e<t;e++){l=c[e];n.push(l.bottom())}return n}())],h=w[0],t=w[1];t+=10;a=e.container.height();n=a-parseFloat(e.spine.css("top"));if(1.1*(t-h)>a){a=1.1*(t-h);e.container.animate({height:a},{duration:200})}else{e.container.animate({height:1.1*(t-h)},{duration:200})}return e.spine.animate({top:100*Math.abs(h)/(t-h)+"%"},{duration:200})};f=function(e){var t;if(e.getDate!=null){return new Date(e.getTime())}t=e.match(/(\d+)/g);return new Date(t[0],t[1]-1,t[2])};a=function(e){return"Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Aug,Nov,Dec".split(",")[e]};u=function(e,t,n){var r,i;if(n==null){n=true}i="0 0 1px black";r=$('<div/ class="circle">').css({background:t,height:e,width:e,"-moz-border-radius":e,"-webkit-border-radius":e,marginTop:-e/2,marginLeft:-e/2});if(n){r.css({"-webkit-box-shadow":i,"-moz-box-shadow":i,"box-shadow":i})}return r};l=function(t,n){var r;r=e.date_to_marker_left_pct(n);return $('<div/ class="wire">').appendTo(e.spine).css("left",r+"%")}}).call(this)